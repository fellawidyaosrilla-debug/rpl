// Data for items (could be fetched from server in real app)
const items = {
    1: { id:1, title:'Kartu BCA', desc:'Kartu debit BCA, bagian depan terdapat nama pemilik, ditemukan dekat gedung G.', image:'kartuatm.jpg', location:'Gedung G, Universitas Andalas', date:'2025-11-10', status:'Ditemukan', contact:'0812-3456-0001', category:'Dokumen' },
    2: { id:2, title:'Helm', desc:'Helm merk XYZ warna hitam, terdapat gores kecil di bagian samping.', image:'helm.jpg', location:'Gedung G, Universitas Andalas', date:'2025-11-12', status:'Ditemukan', contact:'0812-3456-0002', category:'Kendaraan' },
    3: { id:3, title:'Dompet Kulit', desc:'Dompet kulit coklat berisi kartu identitas dan beberapa uang tunai.', image:'dompet.jpg', location:'Gedung G, Universitas Andalas', date:'2025-11-13', status:'Hilang', contact:'0812-3456-0003', category:'Pribadi' },
    4: { id:4, title:'HP iPhone 17', desc:'Handphone iPhone 17 warna hitam, casing retak pada pojok.', image:'hpiphone17.jpg', location:'Gedung H, Universitas Andalas', date:'2025-11-08', status:'Ditemukan', contact:'0812-3456-0004', category:'Elektronik' },
    5: { id:5, title:'Kunci Mobil', desc:'Kunci mobil dengan remote, warna hitam, cocok untuk Toyota Avanza.', image:'kuncimobil.jpg', location:'Parkiran Utama', date:'2025-11-11', status:'Ditemukan', contact:'0812-3456-0005', category:'Kendaraan' },
    6: { id:6, title:'Jam Tangan', desc:'Jam tangan silver dalam keadaan retak pada kaca, strap kulit.', image:'gambar jam.jpg', location:'Gedung H', date:'2025-11-09', status:'Hilang', contact:'0812-3456-0006', category:'Aksesoris' }
};

const grid = document.getElementById('itemsGrid');
const overlay = document.getElementById('overlay');
const modalImage = document.getElementById('modalImage');
const modalTitle = document.getElementById('modalTitle');
const modalDesc = document.getElementById('modalDesc');
const metaRow = document.getElementById('metaRow');
const verifyBtn = document.getElementById('verifyBtn');
const closeModal = document.getElementById('closeModal');
const categorySelect = document.getElementById('categorySelect');


// --- Helper Functions ---

function addMeta(text){
    const el = document.createElement('div');
    el.className = 'meta';
    el.textContent = text;
    metaRow.appendChild(el);
}

function closeDetail(){
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    modalImage.src = '';
}

function openDetail(id){
    const item = items[id];
    if(!item) return;
    
    // Update Modal Content
    modalImage.src = item.image;
    modalImage.alt = item.title;
    modalTitle.textContent = item.title;
    modalDesc.textContent = item.desc;
    
    // Add status badge next to title
    const statusDiv = document.getElementById('modalStatus');
    statusDiv.innerHTML = '';
    const statusBadge = document.createElement('div');
    const statusClass = item.status === 'Hilang' ? 'lost' : 'found';
    statusBadge.className = 'modal-status-badge ' + statusClass;
    statusBadge.textContent = item.status;
    statusDiv.appendChild(statusBadge);
    
    // Update Meta Row
    metaRow.innerHTML = '';
    addMeta('Lokasi: ' + item.location);
    addMeta('Tanggal: ' + item.date);
    addMeta('Kontak: ' + item.contact);
    
    verifyBtn.dataset.id = item.id;
    
    // Populate category filter and related items for this item
    populateCategoryFilter(item);
    
    // Show Modal
    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
}

function populateCategoryFilter(currentItem){
    categorySelect.innerHTML = '<option value="">Semua</option>';
    const cats = new Set();
    Object.values(items).forEach(it=>{ if(it.category) cats.add(it.category); });
    
    Array.from(cats).sort().forEach(cat=>{
        const opt = document.createElement('option'); 
        opt.value = cat; 
        opt.textContent = cat; 
        categorySelect.appendChild(opt);
    });
    
    // render related items with current selection (default none)
    renderRelated(categorySelect.value, currentItem.id);
}

function renderRelated(category, excludeId){
    const list = document.getElementById('relatedList');
    list.innerHTML = '';
    const arr = Object.values(items).filter(it=> (it.id != excludeId) && (!category || it.category === category));
    
    if(arr.length === 0){
        const msg = document.createElement('div'); 
        msg.style.color='#999'; msg.style.fontSize='13px'; msg.style.textAlign='center'; msg.style.padding='16px'; 
        msg.textContent = 'Tidak ada barang terkait.'; 
        list.appendChild(msg); 
        return;
    }
    
    arr.forEach(it=>{
        const card = document.createElement('div'); 
        card.className = 'related-card'; 
        card.tabIndex = 0;
        
        card.innerHTML = `<img src="${it.image}" alt="${it.title}"><div><div class="rc-title">${it.title}</div><div class="rc-location">${it.location}</div></div>`;
        
        card.addEventListener('click', ()=> {
            closeDetail(); // Tutup modal lama
            openDetail(it.id); // Buka modal baru
        });
        card.addEventListener('keydown', (e)=>{ 
            if(e.key === 'Enter') {
                closeDetail();
                openDetail(it.id); 
            }
        });
        list.appendChild(card);
    });
}


// --- Event Listeners Initialization ---

document.addEventListener('DOMContentLoaded', () => {
    // Attach click handlers to cards (delegation)
    grid.addEventListener('click', (e)=>{
        let card = e.target.closest('.card');
        if(!card) return;
        const id = card.getAttribute('data-id');
        openDetail(id);
    });

    // keyboard accessibility: Enter on focused card opens modal
    grid.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
            let card = e.target.closest('.card');
            if(!card) return;
            const id = card.getAttribute('data-id');
            openDetail(id);
        }
    });

    // Close Modal buttons
    closeModal.addEventListener('click', closeDetail);
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeDetail(); });
    
    // Related items filter change
    categorySelect.onchange = (e) => {
        const currentItemId = verifyBtn.dataset.id;
        if (currentItemId) {
            renderRelated(e.target.value, currentItemId);
        }
    };


    // Example verify action (toggles status locally)
    verifyBtn.addEventListener('click', ()=>{
        const id = verifyBtn.dataset.id;
        if(!id) return;
        const item = items[id];
        if(!item) return;
        
        if(item.status === 'Diverifikasi'){
            alert('Barang sudah terverifikasi');
            return;
        }
        item.status = 'Diverifikasi';
        
        // Refresh detail view for verification status change
        openDetail(id); 
        
        alert(`Barang "${item.title}" ditandai sebagai Diverifikasi.`);
    });
});
